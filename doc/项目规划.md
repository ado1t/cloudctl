# cloudctl 项目规划

本文档详细规划了 cloudctl 项目的分阶段实现计划，共分为 10 个阶段，预计 10 周完成。

## 项目概述

cloudctl 是一个用于管理多云平台资源的命令行工具，支持 Cloudflare 和 AWS。

**技术栈**:
- Go 1.25+
- Cobra (CLI 框架)
- Viper (配置管理)
- log/slog (日志系统)
- cloudflare-go (Cloudflare SDK)
- aws-sdk-go-v2 (AWS SDK)

**开发规范**:
- 单元测试覆盖率 > 80%
- 使用语义化版本
- 遵循 Go 代码规范

---

## Phase 1: 基础框架搭建 (第 1 周)

### 1.1 项目初始化
- [x] 创建项目目录结构
- [x] 初始化 go.mod
- [x] 创建 Makefile
- [x] 添加 .gitignore
- [x] 创建 README.md

### 1.2 核心框架
- [x] 集成 Cobra 命令行框架
- [x] 实现根命令和基本命令结构
- [x] 添加 `--help` 和 `--version` 支持

### 1.3 配置系统
- [x] 集成 Viper 配置管理
- [x] 实现配置文件加载（~/.cloudctl/config.yaml）
- [x] 实现环境变量支持
- [x] 实现 Profile 管理
- [x] 创建配置文件示例（conf/config.example.yaml）

### 1.4 日志系统
- [x] 基于 slog 实现日志封装
- [x] 实现日志级别控制（ERROR/WARN/INFO/DEBUG）
- [x] 实现 `-v/-vv/-vvv` 参数支持
- [x] 实现颜色输出（基于 fatih/color）
- [x] 实现文本和 JSON 格式输出

### 1.5 输出格式化
- [x] 实现输出格式化接口
- [x] 实现表格输出（自定义实现）
- [x] 实现 JSON 输出
- [x] 实现文本输出
- [x] 实现 `--output/-o` 参数支持
- [x] 实现 `--no-color` 参数支持

**测试**: 运行 `cloudctl --help` 和 `cloudctl --version`，验证基础框架

**交付物**:
- 可运行的 cloudctl 程序
- 完整的项目结构
- Makefile 构建脚本
- 配置文件示例

---

## Phase 2: Cloudflare Zone 管理 (第 2 周)

### 2.1 Cloudflare SDK 集成
- [x] 添加 cloudflare-go 依赖
- [x] 实现 Cloudflare 客户端初始化
- [x] 实现认证（API Token）
- [x] 实现错误处理封装

### 2.2 Zone List 功能
- [x] 实现 `cloudctl cf zone list` 命令
- [x] 实现表格输出（显示域名、状态、ID、创建时间）
- [x] 实现 JSON 输出
- [x] 添加 `--profile/-p` 参数支持
- [x] 编写单元测试

### 2.3 Zone Create 功能
- [x] 实现 `cloudctl cf zone create <domain>` 命令
- [x] 返回 Zone ID 和 Name Server 信息
- [x] 实现错误处理
- [x] 编写单元测试

**测试**: 使用真实 Cloudflare 账号测试 zone list 和 create 功能

**交付物**:
- Cloudflare Zone 管理功能
- 单元测试
- 集成测试脚本

---

## Phase 3: Cloudflare DNS 管理 (第 3 周)

### 3.1 DNS List 功能
- [x] 实现 `cloudctl cf dns list <domain>` 命令
- [x] 实现 `--type/-t` 参数过滤
- [x] 实现表格和 JSON 输出
- [x] 编写单元测试

### 3.2 DNS Create 功能
- [x] 实现 `cloudctl cf dns create` 命令
- [x] 实现必需参数：`--type/-t`, `--name/-n`, `--content`
- [x] 实现可选参数：`--ttl`, `--proxied`
- [x] 支持记录类型：A, AAAA, CNAME
- [x] 编写单元测试

### 3.3 DNS Update 功能
- [x] 实现 `cloudctl cf dns update <domain> <record-id>` 命令
- [x] 支持更新 content、ttl、proxied 等字段
- [x] 编写单元测试

### 3.4 DNS Delete 功能
- [x] 实现 `cloudctl cf dns delete <domain> <record-id>` 命令
- [x] 实现删除确认提示
- [x] 编写单元测试

### 3.5 DNS 批量操作
- [x] 实现通过 YAML 配置文件批量创建 DNS 记录
- [x] 支持多个 zone，每个 zone 包含多个记录
- [x] 实现 zone 级别和记录级别的进度显示
- [x] 实现失败处理和结果汇总（按 zone 分组）
- [x] 编写单元测试
- [x] 支持 dry-run 预览模式
- [x] 支持并发批量创建（1-10 并发）

**测试**: 创建、列出、更新、删除 DNS 记录，测试批量操作

**交付物**:
- 完整的 DNS 管理功能
- 批量操作支持
- 配置文件示例

---

## Phase 4: Cloudflare Cache 管理 (第 4 周)

### 4.1 Cache Purge 功能
- [x] 实现 `cloudctl cf cache purge <domain>` 命令
- [x] 实现 `--purge-all` 参数（清除全部缓存）
- [x] 实现 `--files/-f` 参数（按 URL 清除）
  - 支持完整 URL：`https://www.51rainbow.xyz/foo/bar/file.html`
  - 支持相对路径：`/foo/bar/file.html`
  - 支持多个文件（逗号分隔或多次指定）
- [x] 实现 `--prefixes` 参数（按目录/前缀清除）
  - 支持目录路径：`/foo/bar/` 或 `/foo/bar`
  - 支持完整 URL 前缀：`https://www.51rainbow.xyz/foo/bar/`
  - 清除指定目录下的所有缓存
  - 支持多个前缀（逗号分隔或多次指定）
- [x] 实现 `--tags/-t` 参数（按 Cache Tag 清除）
  - 支持多个标签（逗号分隔或多次指定）
- [x] 实现 `--hosts` 参数（按主机名清除）
  - 支持多个主机名（逗号分隔或多次指定）
- [x] 实现进度显示和结果反馈
- [x] 编写单元测试

**清除模式说明**:
- `--purge-all`: 清除整个 zone 的所有缓存（最彻底）
- `--files`: 清除指定的文件 URL（精确清除）
- `--prefixes`: 清除指定目录/前缀下的所有内容（目录级清除）
- `--tags`: 清除带有指定 Cache Tag 的内容（需要企业版）
- `--hosts`: 清除指定主机名的所有缓存

**使用示例**:
```bash
# 清除全部缓存
cloudctl cf cache purge example.com --purge-all

# 清除指定文件
cloudctl cf cache purge example.com --files /path/to/file.html
cloudctl cf cache purge example.com -f /css/style.css,/js/app.js

# 清除指定目录下的所有缓存
cloudctl cf cache purge example.com --prefixes /foo/bar/
cloudctl cf cache purge example.com -p /images/,/static/

# 清除指定主机名
cloudctl cf cache purge example.com --hosts www.example.com,api.example.com

# 清除指定标签（企业版）
cloudctl cf cache purge example.com --tags tag1,tag2
```

**测试**: 测试缓存清除功能，验证 Cloudflare 功能模块完整性

**交付物**:
- 缓存管理功能
- 支持多种清除模式
- Cloudflare 模块完成

---

## Phase 5: AWS CloudFront 管理 (第 5 周)

### 5.1 AWS SDK 集成
- [x] 添加 aws-sdk-go-v2 依赖（cloudfront 模块）
- [x] 实现 AWS 客户端初始化
- [x] 实现认证（Access Key/Secret Key）
- [x] 实现区域配置

### 5.2 CDN List 功能
- [x] 实现 `cloudctl aws cdn list` 命令
- [x] 显示分发 ID、域名、状态、源站信息
- [x] 实现表格和 JSON 输出
- [ ] 编写单元测试

### 5.3 CDN Get 功能
- [x] 实现 `cloudctl aws cdn get <distribution-id>` 命令
- [x] 显示分发详细信息
- [ ] 编写单元测试

### 5.4 CDN Create 功能
- [x] 实现 `cloudctl aws cdn create` 命令
- [x] 实现基本参数：`--origin`, `--aliases`
- [x] 实现可选参数：`--certificate-arn`, `--comment`, `--price-class`, `--default-root-object`
- [x] 支持自定义域名和 SSL 证书配置
- [ ] 编写单元测试

### 5.5 CDN Update 功能
- [x] 实现 `cloudctl aws cdn update <distribution-id>` 命令
- [x] 支持更新 comment 和 enabled 状态
- [ ] 编写单元测试

**测试**: 测试 CloudFront 分发的创建、列出、获取、更新功能

**交付物**:
- CloudFront 管理功能
- 完整的命令行接口
- 配置文件支持

---

## Phase 6: AWS CloudFront Invalidation (第 6 周)

### 6.1 Invalidation 功能
- [x] 实现 `cloudctl aws cdn invalidate <distribution-id>` 命令
- [x] 实现 `--paths` 参数（支持多个路径）
- [x] 实现 `--caller-reference` 参数（可选）
- [x] 显示失效请求 ID 和状态
- [x] 编写单元测试

**测试**: 创建缓存失效请求，验证功能正确性

**交付物**:
- CloudFront 缓存失效功能
- 完整的命令行接口
- 单元测试

---

## Phase 7: AWS ACM 证书管理 (第 7 周)

### 7.1 ACM SDK 集成
- [x] 添加 aws-sdk-go-v2 依赖（acm 模块）
- [x] 实现 ACM 客户端初始化

### 7.2 Cert List 功能
- [x] 实现 `cloudctl aws cert list` 命令
- [x] 显示证书 ARN、域名、状态、到期时间
- [x] 实现表格和 JSON 输出
- [x] 编写单元测试

### 7.3 Cert Request 功能
- [x] 实现 `cloudctl aws cert request` 命令
- [x] 实现 `--domain/-d` 参数（主域名）
- [x] 实现 `--san` 参数（备用域名）
- [x] 仅支持 DNS 验证
- [x] 返回证书 ARN 和 DNS 验证记录
- [x] 编写单元测试

### 7.4 Cert Get 功能
- [x] 实现 `cloudctl aws cert get <certificate-arn>` 命令
- [x] 显示证书详细信息和验证状态
- [x] 编写单元测试

### 7.5 Cert 批量操作
- [x] 实现通过 YAML 配置文件批量申请证书
- [x] 实现批量操作进度显示
- [x] 实现失败处理和结果汇总
- [x] 编写单元测试

**测试**: 测试证书申请、列出、获取、批量操作功能

**交付物**:
- ACM 证书管理功能
- 完整的命令行接口
- 批量证书申请
- 单元测试

---

## Phase 8: 高级功能 (第 8 周)

### 8.1 配置管理命令
- [ ] 实现 `cloudctl config validate` 命令
- [ ] 实现 `cloudctl config show` 命令
- [ ] 实现 `cloudctl config list-profiles` 命令
- [ ] 编写单元测试

### 8.2 资源查询快捷命令
- [ ] 实现 `cloudctl cf zone get <domain>` 命令
- [ ] 实现 `cloudctl cf dns get <domain> <record-name>` 命令
- [ ] 实现 `cloudctl aws cdn status <distribution-id>` 命令
- [ ] 实现 `cloudctl aws cdn wait <distribution-id>` 命令
- [ ] 实现 `cloudctl aws cert status <certificate-arn>` 命令
- [ ] 编写单元测试

### 8.3 Dry-run 模式
- [ ] 实现 `--dry-run` 参数
- [ ] 预览操作但不实际执行
- [ ] 显示将要执行的操作详情
- [ ] 为所有创建/更新/删除命令添加 dry-run 支持

### 8.4 简化输出模式
- [ ] 实现 `--quiet/-q` 参数
- [ ] 只输出关键信息（ID、ARN 等）
- [ ] 优化脚本使用场景

### 8.5 Shell 自动补全
- [ ] 实现 bash 自动补全
- [ ] 实现 zsh 自动补全
- [ ] 添加补全安装说明

### 8.6 重试机制
- [ ] 实现 API 调用自动重试
- [ ] 实现指数退避策略
- [ ] 实现 `--no-retry` 参数

**测试**: 测试配置管理、资源查询、dry-run、简化输出、自动补全功能

**交付物**:
- 配置管理工具
- 资源查询快捷命令
- Dry-run 模式
- Shell 自动补全

---

## Phase 9: 测试和文档 (第 9 周)

### 9.1 单元测试
- [ ] 补充所有模块的单元测试
- [ ] 确保测试覆盖率 > 80%
- [ ] 使用 mock 避免实际 API 调用

### 9.2 集成测试
- [ ] 编写端到端集成测试
- [ ] 测试主要功能流程
- [ ] 测试错误处理

### 9.3 文档完善
- [ ] 完善 README.md
- [ ] 编写使用文档
- [ ] 添加示例和最佳实践
- [ ] 创建 CHANGELOG.md

**测试**: 运行完整测试套件，确保所有功能正常

**交付物**:
- 完整的测试套件
- 完善的文档
- 使用示例

---

## Phase 10: 优化和发布 (第 10 周)

### 10.1 性能优化
- [ ] 优化 API 调用性能
- [ ] 优化内存使用
- [ ] 添加性能基准测试

### 10.2 代码质量
- [ ] 运行 golangci-lint 检查
- [ ] 修复所有 lint 警告
- [ ] 代码审查和重构

### 10.3 发布准备
- [ ] 构建所有平台二进制文件
- [ ] 创建发布说明
- [ ] 打标签和发布 v0.1.0

**完成**: 项目第一个版本发布！

**交付物**:
- 多平台二进制文件
- 发布说明
- v0.1.0 版本

---

## 里程碑

| 阶段 | 时间 | 里程碑 | 关键交付物 |
|------|------|--------|-----------|
| Phase 1 | 第 1 周 | 基础框架完成 | 可运行的程序框架 |
| Phase 2-4 | 第 2-4 周 | Cloudflare 功能完成 | Zone、DNS、Cache 管理 |
| Phase 5-7 | 第 5-7 周 | AWS 功能完成 | CloudFront、ACM 管理 |
| Phase 8 | 第 8 周 | 高级功能完成 | 配置管理、快捷命令 |
| Phase 9 | 第 9 周 | 测试和文档完成 | 完整测试、文档 |
| Phase 10 | 第 10 周 | v0.1.0 发布 | 正式版本发布 |

---

## 开发流程

### 每个 Phase 的标准流程

1. **需求确认**: 确认该阶段要实现的功能
2. **设计**: 设计接口和数据结构
3. **实现**: 编写代码
4. **测试**: 编写单元测试和集成测试
5. **文档**: 更新相关文档
6. **验收**: 运行测试，确认功能正常

### 代码提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- feat: 新功能
- fix: 修复 bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

**示例**:
```
feat(cf): add zone list command

Implement cloudctl cf zone list command with table and JSON output.

Closes #1
```

---

## 注意事项

1. **安全性**: 不要在代码中硬编码敏感信息
2. **错误处理**: 所有错误都要妥善处理
3. **日志**: 关键操作要记录日志
4. **测试**: 每个功能都要有测试
5. **文档**: 及时更新文档

---

## 后续计划

v0.1.0 发布后的后续功能：

- [ ] 自动创建 DNS 验证记录（集成 Cloudflare + ACM）
- [ ] API 速率限制
- [ ] 审计日志
- [ ] 阿里云支持
- [ ] 更多 DNS 记录类型（MX, TXT, SRV 等）
- [ ] Web UI（可选）

---

**最后更新**: 2025-11-19
**版本**: v1.0
