# 项目概述

开发一个 `cloudctl` 命令行工具，用于统一管理多云平台资源。支持 Cloudflare、AWS 两个云服务提供商，每个提供商可配置多个账号。

## 设计目标

- **统一接口**: 提供一致的命令行接口管理不同云平台资源
- **多账号支持**: 每个云平台支持配置和切换多个账号
- **易用性**: 清晰的命令结构，友好的输出格式
- **安全性**: 敏感信息通过环境变量或加密配置管理
- **可扩展性**: 便于后续添加新的云平台和功能

# 功能需求

## 1. Cloudflare 功能

### 1.1 域名管理 (Zone Management)
- **列出所有域名**: `cloudctl cf zone list [--profile <name>] [-p <name>]`
  - 显示域名名称、状态、ID、创建时间
  - 支持过滤和搜索
  
- **创建域名**: `cloudctl cf zone create <domain> [--profile <name>] [-p <name>]`
  - 添加新的 Zone 到 Cloudflare 账户
  - 返回 Zone ID 和 Name Server 信息
  
### 1.2 DNS 记录管理
- **列出 DNS 记录**: `cloudctl cf dns list <domain> [--type <A|AAAA|CNAME|...>] [-t <type>] [--profile <name>] [-p <name>]`
  
- **创建 DNS 记录**: `cloudctl cf dns create <domain> --type <type> [-t <type>] --name <name> [-n <name>] --content <content> [--ttl <ttl>] [--proxied] [--profile <name>] [-p <name>]`
  - 支持记录类型: A, CNAME
  - 支持 Cloudflare 代理模式 (proxied)
  
- **更新 DNS 记录**: `cloudctl cf dns update <domain> <record-id> [--content <content>] [--ttl <ttl>] [--proxied] [--profile <name>] [-p <name>]`

- **删除 DNS 记录**: `cloudctl cf dns delete <domain> <record-id> [--profile <name>] [-p <name>]`
  - 删除指定的 DNS 记录
  - 需要提供域名和记录 ID

### 1.3 缓存管理
- **清除缓存**: `cloudctl cf cache purge <domain> [--files <url1,url2,...>] [-f <url1,url2,...>] [--purge-all] [--profile <name>] [-p <name>]`
  - 支持清除全部缓存 (`--purge-all`)
  - 支持按 URL 清除

## 2. AWS 功能

### 2.1 CloudFront CDN 管理
- **列出所有分发**: `cloudctl aws cdn list [--profile <name>] [-p <name>]`
  - 显示分发 ID、域名、状态、源站信息
  
- **创建分发**: `cloudctl aws cdn create --origin <origin> [-o <origin>] --domain <domain> [-d <domain>] [--certificate-arn <arn>] [--config <file>] [-c <file>] [--profile <name>] [-p <name>]`
  - 支持通过配置文件创建复杂配置
  - 基本参数: 源站、自定义域名、证书
  
- **获取分发详情**: `cloudctl aws cdn get <distribution-id> [--profile <name>] [-p <name>]`
  
- **更新分发配置**: `cloudctl aws cdn update <distribution-id> [--config <file>] [-c <file>] [--profile <name>] [-p <name>]`
  - 支持更新源站、缓存行为、自定义错误页面等

- **缓存失效**: `cloudctl aws cdn invalidate <distribution-id> --paths <path1,path2,...> [--caller-reference <ref>] [--profile <name>] [-p <name>]`
  - 创建 CloudFront 缓存失效请求
  - 支持指定多个 URL 路径
  - 示例: `cloudctl aws cdn invalidate E1234567890ABC --paths "/index.html,/images/*"`

### 2.2 ACM 证书管理
- **列出所有证书**: `cloudctl aws cert list [--profile <name>] [-p <name>]`
  - 显示证书 ARN、域名、状态、到期时间
  
- **申请证书**: `cloudctl aws cert request --domain <domain> [-d <domain>] [--san <domain1,domain2,...>] [--profile <name>] [-p <name>]`
  - 仅支持 DNS 验证方式
  - 支持 SAN (Subject Alternative Names)
  - 返回证书 ARN 和 DNS 验证记录信息
  
- **获取证书详情**: `cloudctl aws cert get <certificate-arn> [--profile <name>] [-p <name>]`
  - 显示证书详细信息和验证状态

# 项目结构

```
cloudctl/
├── cmd/                    # 命令行入口
│   └── cloudctl/          # 主程序
│       └── main.go
├── internal/              # 内部包（不对外暴露）
│   ├── cmd/              # 命令实现
│   │   ├── root.go       # 根命令
│   │   ├── cf.go         # Cloudflare 命令
│   │   ├── aws.go        # AWS 命令
│   │   └── config.go     # 配置命令
│   ├── cloudflare/       # Cloudflare 相关实现
│   │   ├── zone.go       # Zone 管理
│   │   ├── dns.go        # DNS 记录管理
│   │   └── cache.go      # 缓存管理
│   ├── aws/              # AWS 相关实现
│   │   ├── cdn.go        # CloudFront 管理
│   │   ├── invalidation.go  # CloudFront 缓存失效
│   │   └── cert.go       # ACM 证书管理
│   ├── config/           # 配置管理
│   │   ├── types.go      # 配置结构体定义
│   │   ├── config.go     # 配置加载和解析
│   │   └── profile.go    # Profile 管理
│   ├── logger/           # 日志系统 (基于 slog)
│   │   ├── logger.go     # 日志封装
│   │   ├── color_handler.go  # 彩色处理器
│   │   └── level.go      # 日志级别管理
│   └── output/           # 输出格式化
│       ├── formatter.go  # 格式化接口
│       ├── json.go       # JSON 输出
│       ├── table.go      # 表格输出
│       └── color.go      # 颜色输出
├── pkg/                   # 公共包（可对外暴露）
│   └── utils/            # 通用工具函数
├── examples/              # 示例和测试程序（不要删除）
│   ├── test-log/         # 日志系统测试
│   │   └── main.go
│   ├── test-output/      # 输出格式化测试
│   │   └── main.go
│   ├── test-config/      # 配置系统测试（待添加）
│   │   └── main.go
│   └── README.md         # 示例说明文档
├── conf/                  # 配置文件示例
│   ├── config.example.yaml
│   ├── batch-workflow.example.yaml
│   ├── certificates.example.yaml
│   └── dns-records.example.yaml
├── doc/                   # 项目文档
│   ├── 需求说明.md
│   ├── 项目规划.md
│   └── 开发日志.md
├── go.mod
├── go.sum
├── Makefile
├── README.md
└── LICENSE
```

# 技术栈

## 核心框架
- **golang**: 1.25+
- **cobra**: 命令行框架，用于构建命令结构
- **pflag**: 命令行参数解析
- **viper**: 配置文件管理

## SDK 依赖
- **cloudflare-go**: Cloudflare API SDK
- **aws-sdk-go-v2**: AWS SDK v2
  - cloudfront 模块
  - acm 模块

## 工具库
- **log/slog**: Go 标准库结构化日志
- **fatih/color**: 终端颜色输出
- **olekukonko/tablewriter**: 表格格式化输出

# 通用功能

## 1. 配置管理

### 1.1 配置文件
- **默认路径**: `~/.cloudctl/config.yaml`
- **自定义路径**: 通过 `--config或 -c` 参数指定
- **配置格式**: YAML

### 1.2 配置文件结构示例
```yaml
# 默认 profile
default_profile:
  cloudflare: cf-prod
  aws: aws-prod

# Cloudflare 配置
cloudflare:
  cf-prod:
    api_token: ${CLOUDFLARE_API_TOKEN}  # 支持环境变量
  cf-dev:
    api_token: ${CLOUDFLARE_DEV_TOKEN}

# AWS 配置
aws:
  aws-prod:
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    region: us-east-1  # ACM 证书申请时使用，CloudFront 不需要
  aws-dev:
    access_key_id: ${AWS_DEV_ACCESS_KEY_ID}
    secret_access_key: ${AWS_DEV_SECRET_ACCESS_KEY}
    region: us-east-1  # ACM 用于 CloudFront 的证书必须在 us-east-1

# 日志配置
log:
  level: info          # debug, info, warn, error
  format: text         # text, json
  output: stdout       # stdout, stderr, file path
  add_source: false    # 是否添加源代码位置信息

# 输出配置
output:
  format: table        # table, json
  color: true          # 启用颜色输出
```

### 1.3 环境变量
环境变量优先级高于配置文件，支持以下变量:

**通用环境变量**:
- `CLOUDCTL_CONFIG`: 配置文件路径
- `CLOUDCTL_PROFILE`: 默认 profile
- `CLOUDCTL_LOG_LEVEL`: 日志级别
- `CLOUDCTL_OUTPUT_FORMAT`: 输出格式
- `CLOUDCTL_NO_COLOR`: 禁用颜色输出（设置为 `true`）

**Cloudflare 环境变量**:
- `CLOUDFLARE_API_TOKEN`: Cloudflare API Token

**AWS 环境变量**:
- `AWS_ACCESS_KEY_ID`: AWS Access Key ID
- `AWS_SECRET_ACCESS_KEY`: AWS Secret Access Key
- `AWS_REGION`: AWS 区域（ACM 使用）
- `AWS_PROFILE`: AWS CLI Profile（可选，支持 AWS CLI 配置）

**配置优先级**: 命令行参数 > 环境变量 > 配置文件 > 默认值

## 2. 全局参数

所有命令支持以下全局参数:
- `--config <path>`, `-c <path>`: 指定配置文件路径
- `--profile <name>`, `-p <name>`: 指定使用的 profile
- `--output <format>`, `-o <format>`: 输出格式 (table|json)
- `--no-color`: 禁用颜色输出
- `--log-level <level>`, `-l <level>`: 日志级别 (debug|info|warn|error)
- `-v, -vv, -vvv`: 详细程度级别（替代 log-level）
  - `-v`: WARN 级别
  - `-vv`: INFO 级别
  - `-vvv`: DEBUG 级别（最详细，包含 API 请求/响应详情）
- `--quiet, -q`: 静默模式，完全不输出日志
- `--help, -h`: 显示帮助信息
- `--version`: 显示版本信息

**注意**: `-v` 系列参数与 `--log-level` 互斥，如果同时指定，`-v` 系列优先级更高。

## 3. 输出格式

### 3.1 表格输出 (默认)
```
+---------------+----------+--------+---------------------+
| INSTANCE ID   | NAME     | STATUS | CREATED             |
+---------------+----------+--------+---------------------+
| i-abc123      | web-01   | Running| 2024-01-01 10:00:00 |
| i-def456      | db-01    | Stopped| 2024-01-02 11:00:00 |
+---------------+----------+--------+---------------------+
```

### 3.2 JSON 输出
```json
{
  "instances": [
    {
      "instance_id": "i-abc123",
      "name": "web-01",
      "status": "Running",
      "created": "2024-01-01T10:00:00Z"
    }
  ]
}
```

## 4. 日志输出

### 4.1 日志级别
- **ERROR**: 错误信息（默认级别）
- **WARN**: 警告信息，不影响执行
- **INFO**: 一般信息，操作进度
- **DEBUG**: 详细的调试信息，包括 API 请求/响应详情

**快捷方式**:
- 默认（无参数）: ERROR
- `-v`: WARN
- `-vv`: INFO
- `-vvv`: DEBUG

### 4.2 日志格式 (基于 slog)

**文本格式** (默认):
```
time=2024-01-01T10:00:00+08:00 level=INFO msg="Creating CloudFront distribution"
time=2024-01-01T10:00:05+08:00 level=DEBUG msg="API Request" method=POST path=/distributions
time=2024-01-01T10:00:06+08:00 level=DEBUG msg="API Response" status=200
time=2024-01-01T10:00:06+08:00 level=INFO msg="Distribution created" id=E1234567890ABC
```

**JSON 格式**:
```json
{"time":"2024-01-01T10:00:00+08:00","level":"INFO","msg":"Creating CloudFront distribution"}
{"time":"2024-01-01T10:00:05+08:00","level":"DEBUG","msg":"API Request","method":"POST","path":"/distributions"}
{"time":"2024-01-01T10:00:06+08:00","level":"DEBUG","msg":"API Response","status":200}
{"time":"2024-01-01T10:00:06+08:00","level":"INFO","msg":"Distribution created","id":"E1234567890ABC"}
```

**颜色输出**:
- ERROR: 红色
- WARN: 黄色
- INFO: 绿色
- DEBUG: 蓝色

## 5. 错误处理

### 5.1 错误信息
- 清晰的错误描述
- 建议的解决方案
- 相关的文档链接

### 5.2 重试机制
- API 调用失败自动重试（可配置）
- 默认重试 3 次，指数退避
- 可通过 `--no-retry` 禁用

### 5.3 退出码
- `0`: 成功
- `1`: 一般错误
- `2`: 配置错误
- `3`: 认证错误
- `4`: API 错误
- `5`: 参数错误

## 6. 其他功能

### 6.1 配置管理命令

- **验证配置**: `cloudctl config validate`
  - 验证配置文件格式是否正确
  - 检查必需字段是否存在
  - 验证认证信息是否有效

- **显示配置**: `cloudctl config show [--profile <name>] [-p <name>]`
  - 显示当前使用的配置
  - 隐藏敏感信息（API Token 等）

- **列出 Profile**: `cloudctl config list-profiles`
  - 列出所有可用的 profile
  - 标记当前默认 profile

### 6.2 资源查询快捷命令

- **获取 Zone 信息**: `cloudctl cf zone get <domain>`
  - 通过域名快速获取 Zone ID 和详细信息
  - 避免每次都要先 list

- **获取 DNS 记录**: `cloudctl cf dns get <domain> <record-name>`
  - 通过域名和记录名查找记录 ID
  - 支持模糊匹配

- **CloudFront 状态**: `cloudctl aws cdn status <distribution-id>`
  - 检查分发部署状态
  - 显示是否已部署完成

- **等待部署完成**: `cloudctl aws cdn wait <distribution-id> [--timeout <seconds>]`
  - 等待 CloudFront 分发部署完成
  - 支持设置超时时间

- **证书验证状态**: `cloudctl aws cert status <certificate-arn>`
  - 显示证书验证状态
  - 显示 DNS 验证记录

### 6.3 批量操作（通过配置文件）

支持通过 YAML 配置文件批量执行操作:

**批量申请证书** (`certs.yaml`):
```yaml
certificates:
  - domain: example1.com
    san:
      - "*.example1.com"
      - www.example1.com
  - domain: example2.com
    san:
      - "*.example2.com"
```

执行:
```bash
cloudctl aws cert request --config certs.yaml
```

**批量创建 DNS 记录** (`dns-records.yaml`):
```yaml
# 支持多个 zone，每个 zone 可以有多个 DNS 记录
zones:
  - zone: example1.com
    records:
      - type: A
        name: www
        content: 1.2.3.4
        ttl: 3600
        proxied: true
      - type: CNAME
        name: blog
        content: example1.com
        proxied: true
  
  - zone: example2.com
    records:
      - type: A
        name: www
        content: 2.3.4.5
        ttl: 3600
        proxied: true
      - type: CNAME
        name: _acme-challenge
        content: "_acme-challenge.example2.com.acm-validations.aws"
        ttl: 300
        proxied: false
```

执行:
```bash
cloudctl cf dns create --config dns-records.yaml
```

**批量操作特性**:
- 支持 YAML 格式配置文件
- 支持多个 zone，每个 zone 可以有多个记录
- 显示批量操作进度（zone 级别和记录级别）
- 失败时继续执行其他项，最后汇总结果
- 支持 `--dry-run` 预览

### 6.4 进度显示

长时间操作自动显示进度:
```
Processing zones... [████████████░░░░░░░░] 2/3 zones
  └─ example1.com: Creating DNS records... [████████████████░░░░] 4/5 records
Creating certificates... [████████████░░░░░░░░] 3/5 (60% complete)
Waiting for CloudFront deployment... [████████████████████] 100% (5m 30s)
```

**触发条件**:
- 批量操作
- 等待资源状态变更（如 CloudFront 部署）
- API 调用超过 3 秒

### 6.5 Dry-run 模式

预览操作但不实际执行:
```bash
cloudctl aws cdn create --origin example.com --domain cdn.example.com --dry-run
cloudctl cf dns create --config dns-records.yaml --dry-run
```

**支持 dry-run 的命令**:
- ✅ 所有创建操作
- ✅ 所有更新操作
- ✅ 所有删除操作
- ✅ 批量操作
- ❌ 查询操作（不需要）

### 6.6 简化输出模式

使用 `--quiet/-q` 只输出关键信息，方便脚本使用:
```bash
# 只输出 Zone ID
ZONE_ID=$(cloudctl cf zone get example.com -q)

# 只输出证书 ARN
CERT_ARN=$(cloudctl aws cert request -d example.com -q)

# 在脚本中使用
cloudctl cf dns create example.com -t A -n www -c $IP_ADDRESS -q
```

# 构建和开发

## Makefile 使用

项目提供了 Makefile 简化常用操作：

### 常用命令
```bash
# 查看所有可用命令
make help

# 编译项目
make build

# 编译所有平台版本
make build-all

# 安装到 GOPATH/bin
make install

# 运行程序
make run

# 开发模式运行（不编译）
make dev

# 清理编译文件
make clean

# 运行测试
make test

# 运行测试并生成覆盖率报告
make test-coverage

# 代码格式化
make fmt

# 代码检查
make lint

# 运行所有检查（fmt + vet + lint + test）
make check

# 整理依赖
make tidy

# 构建发布版本
make release

# 显示版本信息
make version
```

### 编译输出
编译后的二进制文件位于 `build/` 目录：
- `build/cloudctl` - 当前平台可执行文件
- `build/cloudctl-linux-amd64` - Linux AMD64
- `build/cloudctl-linux-arm64` - Linux ARM64
- `build/cloudctl-darwin-amd64` - macOS Intel
- `build/cloudctl-darwin-arm64` - macOS Apple Silicon
- `build/cloudctl-windows-amd64.exe` - Windows

### 开发工作流
```bash
# 1. 格式化代码
make fmt

# 2. 运行检查
make check

# 3. 编译并运行
make run

# 或者直接开发模式运行
make dev
```

# 开发规范

## 1. 代码规范
- 遵循 Go 官方代码规范
- 使用 `gofmt` 格式化代码
- 使用 `golangci-lint` 进行代码检查
- 函数和方法添加注释文档

## 2. 错误处理
- 使用 `errors.Wrap` 包装错误，提供上下文
- 不要忽略错误
- 错误信息对用户友好

## 3. 测试
- 单元测试覆盖率 > 80%
- 集成测试覆盖主要功能
- 使用 mock 避免实际 API 调用

## 4. 版本管理
- 使用语义化版本 (Semantic Versioning)
- 维护 CHANGELOG.md

# 实现计划

详细的分阶段实现计划请参考：[项目规划.md](./项目规划.md)

项目分为 10 个阶段，预计 10 周完成：
- **Phase 1**: 基础框架搭建
- **Phase 2**: Cloudflare Zone 管理
- **Phase 3**: Cloudflare DNS 管理
- **Phase 4**: Cloudflare Cache 管理
- **Phase 5**: AWS CloudFront 管理
- **Phase 6**: AWS CloudFront Invalidation
- **Phase 7**: AWS ACM 证书管理
- **Phase 8**: 高级功能
- **Phase 9**: 测试和文档
- **Phase 10**: 优化和发布

---

# 实现优先级

**注意**: 详细的实现优先级和项目规划已移至 [项目规划.md](./项目规划.md)

本文档保留功能说明和设计决策，具体的分阶段实现计划请参考项目规划文档。

---

# 功能说明

## 已确认的设计决策

### 命令结构
- Cloudflare 子命令使用 `cf` (简化)
- AWS 子命令保持 `aws`
- 阿里云功能暂不实现，后续版本再加入

### 安全性
- **删除功能限制**: 仅 DNS 记录支持删除，其他资源（Zone、CDN、证书）不提供删除功能
- 敏感信息通过环境变量管理
- 配置文件中的敏感信息使用环境变量引用

### 技术选型
- 日志系统使用 Go 标准库 `log/slog`
- 支持颜色输出 (可通过 `--no-color` 禁用)
- ACM 证书申请仅支持 DNS 验证方式

### 不实现的功能
- ❌ 命令别名 (alias) - 通过短参数替代
- ❌ API 调用速率限制（暂不考虑）
- ❌ 审计日志
- ❌ 多语言支持
- ❌ YAML 输出格式
- ❌ 自动创建 DNS 验证记录（后期优化）

### 计划实现的功能
- ✅ Shell 自动补全 (bash/zsh completion)
- ✅ 短参数支持 (如 `-p` 代替 `--profile`)
- ✅ 颜色输出
- ✅ CloudFront 缓存失效
- ✅ 配置文件批量操作
- ✅ 配置验证和管理命令
- ✅ 资源查询快捷命令
- ✅ 简化输出模式（`-q`）
- ✅ Dry-run 模式

---

# 故障排查

## 认证失败

### Cloudflare 认证错误
```
Error: Authentication failed: Invalid API Token
```

**解决方案**:
1. 检查 API Token 是否正确
2. 验证环境变量 `CLOUDFLARE_API_TOKEN` 是否设置
3. 确认 Token 权限是否足够
4. 使用 `-vvv` 查看详细日志

### AWS 认证错误
```
Error: Authentication failed: Invalid credentials
```

**解决方案**:
1. 检查 Access Key 和 Secret Key 是否正确
2. 验证环境变量是否设置
3. 检查 IAM 权限是否足够
4. 确认区域配置是否正确

## 网络问题

### 连接超时
```
Error: Request timeout after 30s
```

**解决方案**:
1. 检查网络连接
2. 检查防火墙设置
3. 增加超时时间（在配置文件中设置）
4. 使用 `--no-retry` 禁用重试查看原始错误

### API 限流
```
Error: Rate limit exceeded, retry after 60s
```

**解决方案**:
1. 等待限流时间结束
2. 减少并发请求
3. 使用批量操作减少 API 调用次数

## 配置问题

### 配置文件格式错误
```
Error: Invalid YAML format in config file
```

**解决方案**:
1. 使用 `cloudctl config validate` 验证配置
2. 检查 YAML 格式是否正确
3. 确认缩进使用空格而非 Tab
4. 参考 `conf/config.example.yaml`

### Profile 不存在
```
Error: Profile 'xxx' not found
```

**解决方案**:
1. 使用 `cloudctl config list-profiles` 查看可用 profile
2. 检查配置文件中是否定义了该 profile
3. 检查配置文件路径是否正确

## 资源操作问题

### Zone 不存在
```
Error: Zone 'example.com' not found
```

**解决方案**:
1. 使用 `cloudctl cf zone list` 查看所有 zone
2. 确认域名拼写是否正确
3. 确认使用了正确的 profile

### DNS 记录冲突
```
Error: DNS record already exists
```

**解决方案**:
1. 使用 `cloudctl cf dns list <domain>` 查看现有记录
2. 更新现有记录而非创建新记录
3. 删除冲突的记录后重新创建

### CloudFront 部署中
```
Warning: Distribution is still deploying, please wait
```

**解决方案**:
1. 使用 `cloudctl aws cdn status <id>` 检查状态
2. 使用 `cloudctl aws cdn wait <id>` 等待部署完成
3. CloudFront 部署通常需要 10-15 分钟

## 调试技巧

### 查看详细日志
```bash
# 使用不同的日志级别
cloudctl cf zone list -v      # WARN
cloudctl cf zone list -vv     # INFO
cloudctl cf zone list -vvv    # DEBUG (包含 API 请求/响应)
```

### 使用 Dry-run 模式
```bash
# 预览操作而不实际执行
cloudctl cf dns create example.com -t A -n test -c 1.2.3.4 --dry-run
```

### 验证配置
```bash
# 验证配置文件
cloudctl config validate

# 查看当前配置
cloudctl config show
```

---

# 最佳实践

## 配置管理

### 使用环境变量
```bash
# 不要在配置文件中硬编码敏感信息
# 错误示例
cloudflare:
  cf-prod:
    api_token: "sk-1234567890abcdef"  # ❌ 不要这样做

# 正确示例
cloudflare:
  cf-prod:
    api_token: ${CLOUDFLARE_API_TOKEN}  # ✅ 使用环境变量
```

### 分离环境配置
```yaml
# 为不同环境创建不同的 profile
default_profile:
  cloudflare: cf-prod
  aws: aws-prod

cloudflare:
  cf-prod:
    api_token: ${CLOUDFLARE_PROD_TOKEN}
  cf-staging:
    api_token: ${CLOUDFLARE_STAGING_TOKEN}
  cf-dev:
    api_token: ${CLOUDFLARE_DEV_TOKEN}
```

## 批量操作

### 使用配置文件
```bash
# 批量创建 DNS 记录
# 创建 dns-records.yaml
cloudctl cf dns create --config dns-records.yaml

# 批量申请证书
# 创建 certs.yaml
cloudctl aws cert request --config certs.yaml
```

### 先 Dry-run 再执行
```bash
# 1. 预览操作
cloudctl cf dns create --config dns-records.yaml --dry-run

# 2. 确认无误后执行
cloudctl cf dns create --config dns-records.yaml
```

## 脚本使用

### 使用简化输出
```bash
#!/bin/bash

# 获取 Zone ID
ZONE_ID=$(cloudctl cf zone get example.com -q)

# 创建 DNS 记录
cloudctl cf dns create example.com -t A -n www -c $SERVER_IP -q

# 申请证书
CERT_ARN=$(cloudctl aws cert request -d example.com -q)

echo "Certificate ARN: $CERT_ARN"
```

### 错误处理
```bash
#!/bin/bash
set -e  # 遇到错误立即退出

# 检查配置
if ! cloudctl config validate; then
    echo "Configuration is invalid"
    exit 1
fi

# 执行操作
cloudctl cf zone create example.com || {
    echo "Failed to create zone"
    exit 1
}
```

## 性能优化

### 减少 API 调用
```bash
# ❌ 不好的做法：多次调用
cloudctl cf dns create example.com -t A -n www -c 1.2.3.4
cloudctl cf dns create example.com -t A -n api -c 1.2.3.5
cloudctl cf dns create example.com -t A -n blog -c 1.2.3.6

# ✅ 好的做法：批量操作
cloudctl cf dns create --config dns-records.yaml
```

### 使用查询快捷命令
```bash
# ❌ 不好的做法
cloudctl cf zone list | grep example.com

# ✅ 好的做法
cloudctl cf zone get example.com
```

## 证书管理

### 单个证书申请流程
```bash
# 1. 申请证书（仅 DNS 验证）
CERT_ARN=$(cloudctl aws cert request -d example.com --san "*.example.com" -q)

# 2. 查看验证记录
cloudctl aws cert get $CERT_ARN

# 3. 在 Cloudflare 添加验证记录
cloudctl cf dns create example.com -t CNAME -n _acme-challenge -c <validation-value>

# 4. 等待验证完成
cloudctl aws cert status $CERT_ARN

# 5. 在 CloudFront 中使用证书
cloudctl aws cdn create --origin example.com --domain cdn.example.com --certificate-arn $CERT_ARN
```

### 批量证书申请流程
```bash
# 1. 批量申请证书（certs.yaml）
cloudctl aws cert request --config certs.yaml

# 2. 获取所有证书的验证记录
# 输出会包含所有域名的 DNS 验证记录

# 3. 批量创建 DNS 验证记录（dns-records.yaml）
# 配置文件示例：
# zones:
#   - zone: example1.com
#     records:
#       - type: CNAME
#         name: _acme-challenge
#         content: "_acme-challenge.example1.com.acm-validations.aws"
#         ttl: 300
#         proxied: false
#   - zone: example2.com
#     records:
#       - type: CNAME
#         name: _acme-challenge
#         content: "_acme-challenge.example2.com.acm-validations.aws"
#         ttl: 300
#         proxied: false

cloudctl cf dns create --config dns-records.yaml

# 4. 等待所有证书验证完成
# 可以逐个检查或编写脚本批量检查
```

## CloudFront 部署

### 完整部署流程
```bash
# 1. 创建分发
DIST_ID=$(cloudctl aws cdn create --origin example.com --domain cdn.example.com -q)

# 2. 等待部署完成
cloudctl aws cdn wait $DIST_ID

# 3. 更新 DNS 指向 CloudFront
cloudctl cf dns create example.com -t CNAME -n cdn -c ${DIST_ID}.cloudfront.net

# 4. 更新内容后刷新缓存
cloudctl aws cdn invalidate $DIST_ID --paths "/*"
```

## 日志管理

### 开发环境
```bash
# 使用详细日志
export CLOUDCTL_LOG_LEVEL=debug
cloudctl cf zone list -vvv
```

### 生产环境
```bash
# 使用适度日志
export CLOUDCTL_LOG_LEVEL=info
cloudctl cf zone list -vv
```

### 脚本环境
```bash
# 静默模式，只输出关键信息
cloudctl cf zone create example.com -q
```

# 开发和测试

## Examples 目录

`examples/` 目录用于存放各个功能模块的示例和测试程序。

### 目录约定

- 所有测试命令和示例程序都放在 `examples/` 目录的独立子目录中
- 每个示例程序都在独立的子目录中，包含一个 `main.go` 文件
- 这样避免了多个 `package main` 冲突的问题
- 示例程序不会被包含在最终的 cloudctl 二进制文件中
- 示例程序主要用于开发和测试，方便验证功能
- **重要**：不要删除 examples 目录中的文件

### 当前示例

#### test-log - 日志系统测试

测试日志系统的各种功能，包括日志级别、颜色输出、详细程度等。

```bash
# 默认日志级别（ERROR）
go run examples/test-log/main.go

# INFO 级别
go run examples/test-log/main.go -v

# DEBUG 级别
go run examples/test-log/main.go -vv

# DEBUG + 源码位置
go run examples/test-log/main.go -vvv

# 指定日志级别
go run examples/test-log/main.go --log-level debug

# 禁用颜色输出
go run examples/test-log/main.go --no-color

# 静默模式
go run examples/test-log/main.go -q
```

#### test-output - 输出格式化测试

测试输出格式化系统的各种功能，包括表格、JSON、文本格式输出。

```bash
# 表格格式（默认）
go run examples/test-output/main.go

# JSON 格式
go run examples/test-output/main.go --output json

# 文本格式
go run examples/test-output/main.go --output text

# 禁用颜色输出
go run examples/test-output/main.go --no-color
```

### 未来示例

随着项目开发，将添加更多示例：

- **test-config/** - 配置系统示例
- **test-cloudflare/** - Cloudflare API 调用示例
- **test-aws/** - AWS API 调用示例
