# 输出格式化使用指南

本文档说明如何在 cloudctl 的子命令中使用输出格式化系统。

## 概述

cloudctl 提供了统一的输出格式化系统，支持多种输出格式：
- **table** - 表格格式（默认）
- **json** - JSON 格式
- **text** - 文本格式
- **yaml** - YAML 格式（保留，未实现）

## 全局参数

用户可以通过以下全局参数控制输出格式：

```bash
# 指定输出格式
cloudctl <command> --output json
cloudctl <command> -o json

# 禁用颜色输出
cloudctl <command> --no-color

# 静默模式（不输出任何内容）
cloudctl <command> --quiet
cloudctl <command> -q
```

## 在子命令中使用

### 基本用法

在子命令的 `Run` 或 `RunE` 函数中，通过 `cmd.GetFormatter()` 获取全局格式化器：

```go
package cmd

import (
    "github.com/panda2xx/cloudctl/internal/cmd"
    "github.com/spf13/cobra"
)

var listCmd = &cobra.Command{
    Use:   "list",
    Short: "列出资源",
    RunE: func(c *cobra.Command, args []string) error {
        // 获取全局格式化器
        formatter := cmd.GetFormatter()
        
        // 准备数据
        data := []map[string]interface{}{
            {"id": "1", "name": "Resource A", "status": "active"},
            {"id": "2", "name": "Resource B", "status": "inactive"},
        }
        
        // 格式化输出
        return formatter.Format(data)
    },
}
```

### 支持的数据类型

格式化器支持多种数据类型：

#### 1. Map 切片
```go
data := []map[string]interface{}{
    {"name": "Alice", "age": 30},
    {"name": "Bob", "age": 25},
}
formatter.Format(data)
```

**输出（table）**:
```
name   age
-----  ---
Alice  30 
Bob    25 
```

#### 2. 单个 Map
```go
data := map[string]interface{}{
    "name": "Alice",
    "age":  30,
    "city": "Beijing",
}
formatter.Format(data)
```

**输出（table）**:
```
Key   Value  
----  -------
name  Alice  
age   30     
city  Beijing
```

#### 3. 结构体切片
```go
type User struct {
    Name string `json:"name"`
    Age  int    `json:"age"`
    City string `json:"city"`
}

data := []User{
    {Name: "Alice", Age: 30, City: "Beijing"},
    {Name: "Bob", Age: 25, City: "Shanghai"},
}
formatter.Format(data)
```

**输出（table）**:
```
name   age  city    
-----  ---  --------
Alice  30   Beijing 
Bob    25   Shanghai
```

#### 4. 单个结构体
```go
data := User{Name: "Alice", Age: 30, City: "Beijing"}
formatter.Format(data)
```

**输出（table）**:
```
Field  Value  
-----  -------
name   Alice  
age    30     
city   Beijing
```

### 表格格式化器的特殊方法

如果需要使用表格格式化器的特殊方法（如打印状态消息），可以进行类型断言：

```go
formatter := cmd.GetFormatter()

if tableFormatter, ok := formatter.(*output.TableFormatter); ok {
    tableFormatter.PrintSuccess("操作成功")
    tableFormatter.PrintError("发生错误")
    tableFormatter.PrintWarning("警告信息")
    tableFormatter.PrintInfo("提示信息")
}
```

### 手动构建表格

对于复杂的表格，可以手动构建：

```go
formatter := cmd.GetFormatter()

if tableFormatter, ok := formatter.(*output.TableFormatter); ok {
    tableFormatter.SetHeaders([]string{"ID", "Name", "Status"})
    tableFormatter.AddRow([]string{"1", "Task A", "Completed"})
    tableFormatter.AddRow([]string{"2", "Task B", "In Progress"})
    tableFormatter.AddRow([]string{"3", "Task C", "Pending"})
    return tableFormatter.Render()
}
```

## 配置文件

用户也可以在配置文件中设置默认的输出格式：

```yaml
output:
  format: table  # 默认输出格式
  color: true    # 启用颜色输出
```

**优先级**：命令行参数 > 配置文件

## 最佳实践

### 1. 始终返回错误

```go
RunE: func(c *cobra.Command, args []string) error {
    formatter := cmd.GetFormatter()
    return formatter.Format(data)
}
```

### 2. 处理空数据

```go
if len(data) == 0 {
    fmt.Println("没有找到数据")
    return nil
}
return formatter.Format(data)
```

### 3. 使用结构体标签

为结构体字段添加 `json` 标签，控制字段名显示：

```go
type Resource struct {
    ID     string `json:"id"`
    Name   string `json:"name"`
    Status string `json:"status"`
    // 不导出的字段不会显示
    internal string
}
```

### 4. 错误处理

```go
if err := formatter.Format(data); err != nil {
    return fmt.Errorf("格式化输出失败: %w", err)
}
```

## 示例

完整的子命令示例：

```go
package cloudflare

import (
    "github.com/panda2xx/cloudctl/internal/cmd"
    "github.com/spf13/cobra"
)

var zoneListCmd = &cobra.Command{
    Use:   "list",
    Short: "列出所有 Zone",
    RunE: func(c *cobra.Command, args []string) error {
        // 1. 调用 API 获取数据
        zones, err := getZones()
        if err != nil {
            return err
        }
        
        // 2. 检查是否有数据
        if len(zones) == 0 {
            fmt.Println("没有找到 Zone")
            return nil
        }
        
        // 3. 获取格式化器并输出
        formatter := cmd.GetFormatter()
        return formatter.Format(zones)
    },
}
```

## 测试

在测试中，可以创建临时的格式化器：

```go
func TestListCommand(t *testing.T) {
    buf := &bytes.Buffer{}
    formatter := output.NewTableFormatter(buf, false)
    
    data := []map[string]interface{}{
        {"name": "test"},
    }
    
    err := formatter.Format(data)
    if err != nil {
        t.Errorf("Format() error = %v", err)
    }
    
    output := buf.String()
    if !strings.Contains(output, "test") {
        t.Error("输出应包含 'test'")
    }
}
```

## 注意事项

1. **不要直接使用 fmt.Println**：应该使用格式化器输出，以支持不同的输出格式
2. **静默模式**：在静默模式下，格式化器不会输出任何内容
3. **颜色支持**：颜色输出会自动检测终端支持，在管道或重定向时自动禁用
4. **JSON 标签**：结构体字段的 JSON 标签会影响表格和 JSON 输出的字段名

## 参考

- [输出格式化实现](../internal/output/)
- [示例程序](../examples/test-output/)
- [单元测试](../internal/output/formatter_test.go)
